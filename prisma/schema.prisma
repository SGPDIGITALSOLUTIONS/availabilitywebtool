// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ClinicCache {
  id          String   @id @default(cuid())
  clinicName  String   @unique
  shifts      Json     // Array of ShiftData
  lastUpdated DateTime @default(now())
  lastScraped   DateTime  @default(now())
  error       String?
  
  @@index([lastUpdated])
  @@index([clinicName])
  @@map("clinic_cache")
}

model ScrapeJob {
  id             String    @id @default(cuid())
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  status         String    // "running" | "completed" | "failed"
  clinicsScraped Int       @default(0)
  error          String?
  
  @@index([startedAt])
  @@map("scrape_job")
}

model User {
  id                String   @id @default(cuid())
  username          String   @unique
  password          String   // Hashed password
  mustChangePassword Boolean @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relationships
  allocatedTasks    Task[]   @relation("AllocatedByUser")
  
  @@index([username])
  @@map("user")
}

model Forecast {
  id              String   @id @default(cuid())
  name            String   // Forecast name (required)
  dateRangeStart  DateTime
  dateRangeEnd    DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Variable inputs
  nhsTestValue        Float   @default(0)
  nhsEligiblePercent  Float   @default(0)  // e.g., 0.75 for 75%
  gos3EligiblePercent Float   @default(0)  // e.g., 0.20 for 20%
  averageGos3Value    Float   @default(0)
  
  // Relationships
  clinicTargets       ForecastClinicTarget[]
  
  @@index([createdAt])
  @@index([name])
  @@map("forecast")
}

model ForecastClinicTarget {
  id                    String   @id @default(cuid())
  forecastId            String
  clinicName            String   // e.g., "Birmingham", "Edinburgh Skylight"
  targetClinics         Int      // Target number of clinics for this clinic
  targetTests           Int      // Target number of tests for this clinic
  
  forecast              Forecast @relation(fields: [forecastId], references: [id], onDelete: Cascade)
  
  @@unique([forecastId, clinicName])
  @@index([forecastId])
  @@map("forecast_clinic_target")
}

model Task {
  id                    String   @id @default(cuid())
  title                 String
  description           String?
  startDate             DateTime
  deadline              DateTime
  status                String   @default("pending") // "pending" | "in_progress" | "completed"
  importance            Int      @default(3) // 1-5
  notes                 String?
  
  // Meeting fields
  meetingType           String?  // "in_person" | "call" | null
  location              String?  // For in-person meetings
  meetingLink           String?  // For call meetings (Teams/Zoom)
  
  // Recurrence
  recurrence            String   @default("none") // "none" | "daily" | "weekly" | "monthly" | "custom"
  recurrenceDays        String?  // Comma-separated days for custom (e.g., "monday,wednesday,friday")
  
  // Task type flags
  isCustomMeeting       Boolean  @default(false)
  isPersonalTask        Boolean  @default(false)
  
  // Allocated by fields
  allocatedByUserId     String?
  allocatedByOverride   String?  // Manual override text
  
  // Relationships
  allocatedByUser       User?    @relation("AllocatedByUser", fields: [allocatedByUserId], references: [id], onDelete: SetNull)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([status])
  @@index([deadline])
  @@index([allocatedByUserId])
  @@map("task")
}

model AuditLog {
  id            String   @id @default(cuid())
  action        String   // e.g., "login", "task_created", "task_deleted", "note_added", etc.
  userId        String?  // User who performed the action
  username      String?  // Username for reference (denormalized)
  details       String?  // Additional details (JSON string or text)
  ipAddress     String?  // IP address of the user
  userAgent     String?  // User agent string
  createdAt     DateTime @default(now())
  
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_log")
}

model AppUpdate {
  id            String   @id @default(cuid())
  title         String
  content       String   // Markdown or plain text content
  priority      String   @default("normal") // "low", "normal", "high", "urgent"
  isActive      Boolean  @default(true)
  createdBy     String   // User ID who created the update
  createdByUsername String? // Username for reference
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime? // Optional expiration date
  
  @@index([isActive])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("app_update")
}
